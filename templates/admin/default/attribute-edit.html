{extends file="admin-layout.tpl"}

{block name="page-title"}{intl l='Edit an attribute'}{/block}

{block name="check-permissions"}admin.configuration.attributes.edit{/block}

{block name="main-content"}
<div class="attributes edit-attribute">

    <div id="wrapper" class="container">

        {loop name="attribute_edit" type="attribute" id=$attribute_id backend_context="1" lang=$edit_language_id}

            <ul class="breadcrumb">
    			<li><a href="{url path='/admin/home'}">{intl l="Home"}</a></li>
                <li><a href="{url path='/admin/configuration'}">{intl l="Configuration"}</a></li>
                <li><a href="{url path='/admin/configuration/attributes'}">{intl l="Attributes"}</a></li>
                <li>{intl l='Editing attribute "%name"' name="{$TITLE}"}</li>
            </ul>

    		<div class="row">
    			<div class="col-md-12 general-block-decorator">
    				<div class="row">

    					<div class="col-md-12 title title-without-tabs">
    					   {intl l="Edit attribute $TITLE"}
    					</div>

                        <div class="col-md-12">
                         <div class="form-container">

                             {include file="includes/inner-form-toolbar.html" close_url="{url path='/admin/configuration/attributes'}"}

                             <div class="col-md-6">

                                 <p class="title title-without-tabs">{intl l='Attribute information'}</p>

     						    {form name="thelia.admin.attribute.modification"}
     						    	<form method="POST" action="{url path='/admin/configuration/attributes/save'}" {form_enctype form=$form} class="clearfix">

     	                                {* Be sure to get the attribute ID, even if the form could not be validated *}
     	                                <input type="hidden" name="attribute_id" value="{$attribute_id}" />

     						        	{form_hidden_fields form=$form}

     						        	{form_field form=$form field='success_url'}
     						        		<input type="hidden" name="{$name}" value="{url path='/admin/configuration/attributes'}" />
     						        	{/form_field}

     			                        {form_field form=$form field='locale'}
     			                        	<input type="hidden" name="{$name}" value="{$edit_language_locale}" />
     			                        {/form_field}

     					            	{if $form_error}<div class="alert alert-danger">{$form_error_message}</div>{/if}

                                         {include file="includes/standard-description-form-fields.html"}

                                     </form>
     							{/form}

     						</div>

     						<div class="col-md-6">

     						    <p class="title title-without-tabs">

     						         {intl l='Attribute values'}

                                     {loop type="auth" name="can_create" roles="ADMIN" permissions="admin.configuration.attribute-values.create"}
                                     <span class="pull-right">
                                         <a data-toggle="modal" href="#creation_dialog" title="Add a new attribute value" class="btn btn-default btn-primary">
                                             <span class="glyphicon glyphicon-plus-sign"></span>
                                         </a>
                                     </span>
                                     {/loop}
     						    </p>

     						    <div class="alert alert-info">
     						     {intl l="Enter here all possible attribute values. If you don't enter any value, you will be able to set a free value to this attribute on the product form."}
     						    </div>

                        <table class="table table-striped table-condensed table-left-aligned">
                            <thead>
                                <tr>
                                    <th>
                                        {admin_sortable_header
                                            current_order=$order
                                            order='id'
                                            reverse_order='id_reverse'
                                            path={url path='/admin/configuration/attributes/update' attribute_id=$attribute_id}
                                            label="{intl l='ID'}"
                                        }
                                    </th>

                                    <th>
                                        {admin_sortable_header
                                            current_order=$order
                                            order='alpha'
                                            reverse_order='alpha_reverse'
                                            path={url path='/admin/configuration/attributes/update' attribute_id=$attribute_id}
                                            label="{intl l='Value'}"
                                        }
                                    </th>

                                    <th class="text-center">
                                        {admin_sortable_header
                                            current_order=$order
                                            order='manual'
                                            reverse_order='manual_reverse'
                                            path={url path='/admin/configuration/attributes/update' attribute_id=$attribute_id}
                                            label="{intl l="Position"}"
                                        }
                                    </th>

                                    {module_include location='attributes_value_table_header'}

                                    <th class="actions">{intl l="Actions"}</th>
                                </tr>
                            </thead>

                            <tbody>
                                {loop name="list" type="attribute_availability" attribute=$attribute_id backend_context="1" lang=$edit_language_id order=$order}
                                <tr>
                                    <td>{$ID}</td>

                                    <td>
                                        <input class="js-edit form-control" type="text" name="" value="{$TITLE}" />
                                    </td>

                                    <td class="text-center">
                                        {admin_position_block
                                        permission="admin.attributes.edit"
                                        path="/admin/configuration/attributes/update-value-position"
                                        url_parameter="attribute_id"
                                        in_place_edit_class="positionChange"
                                        position="$POSITION"
                                        id="$ID"
                                        }
                                    </td>

                                    {module_include location='attributes_value_table_row'}

                                    <td class="actions">
                                        <div class="btn-group">
                                            <a class="btn btn-default btn-xs value-delete" title="{intl l='Delete this value'}" href="#delete_dialog" data-id="{$ID}" data-toggle="modal"><span class="glyphicon glyphicon-trash"></span></a>
                                        </div>
                                    </td>
                                </tr>
                                 {/loop}

                                 {elseloop rel="list"}
                                     <tr>
                                         <td colspan="4">
                                             <div class="alert alert-info">
                                                 {intl l="No product attribute has been created yet. Click the + button to create one."}
                                             </div>
                                         </td>
                                     </tr>
                                 {/elseloop}
                            </tbody>
                        </table>
     						</div>
     					</div>
                        </div>
    				</div>
    			</div>

    		</div>

		{/loop}

        {elseloop rel="attribute_edit"}
            <div class="row">
                <div class="col-md-12">
                    <div class="alert alert-error">
                        {intl l="Sorry, attribute ID=$attribute_id was not found."}
                    </div>
                </div>
            </div>
        {/elseloop}

    </div>
</div>

{* Adding a new attribute *}

{form name="thelia.admin.attribute-value.creation"}

    {* Capture the dialog body, to pass it to the generic dialog *}

    {capture "creation_dialog"}
        {form_hidden_fields form=$form}

        {* Be sure to get the attribute ID, even if the form could not be validated *}
        <input type="hidden" name="attribute_id" value="{$attribute_id}" />

        {form_field form=$form field='success_url'}
            {* on success, redirect to this page  *}
            <input type="hidden" name="{$name}" value="{url path='/admin/configuration/attributes/update' attribute_id=$attribute_id}" />
        {/form_field}

        {form_field form=$form field='attribute_id'}
        <input type="hidden" name="{$name}" value="{$attribute_id}" />
        {/form_field}

        {form_field form=$form field='title'}
            <div class="form-group {if $error}has-error{/if}">
                <label for="{$label_attr.for}" class="control-label">{intl l="{$label}"} : </label>

                {loop type="lang" name="current-edit-lang" id="$edit_language_id"}
                    <div class="input-group">
                        <input type="text" id="{$label_attr.for}" required="required" name="{$name}" class="form-control" value="{$value}" title="{intl l='Attribute title'}" placeholder="{intl l='Title'}">
                        <span class="input-group-addon"><img src="{image file="assets/img/flags/{$CODE}.gif"}" alt="{intl l=$TITLE}" /></span>
                    </div>

                    <div class="help-block">{intl l="Enter here the value in the current edit language ($TITLE)"}</div>

                    {form_field form=$form field='locale'}
                        <input type="hidden" name="{$name}" value="{$LOCALE}" />
                    {/form_field}
                {/loop}
            </div>
        {/form_field}

        {module_include location='attribute_value_create_form'}

    {/capture}

    {include
        file = "includes/generic-create-dialog.html"

        dialog_id    = "creation_dialog"
        dialog_title = {intl l="Create a new attribute value"}
        dialog_body  = {$smarty.capture.creation_dialog nofilter}

        dialog_ok_label     = {intl l="Create this value"}

        form_action        = {url path='/admin/configuration/attributes/create-value'}
        form_enctype       = {form_enctype form=$form}
        form_error_message = $form_error_message
    }
{/form}

{* Delete value confirmation dialog *}

{capture "delete_dialog"}
    <input type="hidden" name="attribute_value_id" id="value_delete_id" value="" />
{/capture}

{include
    file = "includes/generic-confirm-dialog.html"

    dialog_id       = "delete_dialog"
    dialog_title    = {intl l="Delete attribute value"}
    dialog_message  = {intl l="Do you really want to delete this attribute value ?"}

    form_action     = {url path='/admin/configuration/attributes/delete-value'}
    form_content    = {$smarty.capture.delete_dialog nofilter}
}

{/block}

{block name="javascript-initialization"}

    {javascripts file='assets/js/bootstrap-editable/bootstrap-editable.js'}
        <script src="{$asset_url}"></script>
    {/javascripts}

    <script>
        $(function() {

            // Set proper attribute ID in delete from
            $('a.value-delete').click(function(ev) {
                $('#value_delete_id').val($(this).data('id'));
            });

            // JS stuff for creation form
            {include
                file      = "includes/generic-js-dialog.html"
                dialog_id = "creation_dialog"
                form_name = "thelia.admin.attribute-value.creation"
            }

            {* Inline editing of object position using bootstrap-editable *}

            $('.positionChange').editable({
                type        : 'text',
                title       : '{intl l="Enter new value position"}',
                mode        : 'popup',
                inputclass  : 'input-mini',
                placement   : 'left',
                success     : function(response, newValue) {
                    // The URL template
                    var url = "{url path='/admin/configuration/attributes/update-value-position' attribute_value_id='__ID__' position='__POS__'}";

                    // Perform subtitutions
                    url = url.replace('__ID__', $(this).data('id')).replace('__POS__', newValue);

                    // Reload the page
                    location.href = url;
                }
            });

        });
    </script>
{/block}